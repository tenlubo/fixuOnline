version: '3.7'

services:

  activiti-modeling-backend:
    container_name: activiti-modeling-backend
    image: activiti/activiti-cloud-modeling:7.1.938
    environment:
      JAVA_OPTS:                    -Xmx1024m -Xms512m -XX:+UnlockExperimentalVMOptions   -Dsun.zip.disableMemoryMapping=true -XX:+UseParallelGC -XX:MinHeapFreeRatio=5 -XX:MaxHeapFreeRatio=10 -XX:GCTimeRatio=4 -XX:AdaptiveSizePolicyWeight=90
      SPRING_APPLICATION_NAME:      modeling-service
      SERVER_PORT:                  8080
      ACT_KEYCLOAK_URL:             http://${DOCKER_IP}/auth
      ACT_KEYCLOAK_REALM:           ${KEYCLOAK_REALM}
      ACT_KEYCLOAK_RESOURCE:        ${KEYCLOAK_RESOURCE}
      ACTIVITI_CLOUD_MODELING_URL:  localhost:8080
      SERVER_SERVLET_CONTEXT_PATH:  /modeling-service
      ACTIVITI_CSRF_DISABLED: 'true'
      ACTIVITI_CORS_ENABLED: 'true'
    ports:
      - 9998:8080

  activiti-modeling-app:
    container_name: activiti-modeling-app
    image: activiti/activiti-modeling-app:7.1.8
    environment:
      # JAVA_OPTS: "-Xdebug -Xrunjdwp:server=y,transport=dt_socket,address=8000,suspend=n -noverify"
      APP_CONFIG_OAUTH2_HOST: "http://${DOCKER_IP}/auth/realms/${KEYCLOAK_REALM}"
      APP_CONFIG_OAUTH2_CLIENTID: "${KEYCLOAK_REALM}"
      API_URL: "http://${DOCKER_IP}"
      BASE_PATH: /modeling/
      APP_CONFIG_BPM_HOST: "http://${DOCKER_IP}/modeling-service"
      APP_CONFIG_OAUTH2_REDIRECT_SILENT_IFRAME_URI: /modeling/assets/silent-refresh.html
      APP_CONFIG_OAUTH2_REDIRECT_LOGIN: /modeling
      APP_CONFIG_OAUTH2_REDIRECT_LOGOUT: /modeling
    restart: unless-stopped

  keycloak:
    container_name: keycloak
    image: activiti/activiti-keycloak:10.0.2
    volumes:
      - type: bind
        source: ./activiti-realm.json
        target: /opt/jboss/keycloak/activiti-realm.json
        read_only: true
    restart: unless-stopped
    ports:
      - 9999:8180
    depends_on:
      - nginx

  nginx:
    image: nginx:stable-alpine
    container_name: nginx
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf
    ports:
      - 80:80
      - 443:443
    restart: unless-stopped
